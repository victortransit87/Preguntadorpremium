<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PregunteitorPlus - Versi칩n Premium</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons (via unpkg for simplicity in single file) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }

        .animate-enter {
            animation: enter 0.5s ease-out forwards;
        }

        @keyframes enter {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        secondary: { 500: '#ec4899', 600: '#db2777' }
                    }
                }
            }
        }
    </script>
</head>

<body class="text-slate-800 antialiased selection:bg-primary-100 selection:text-primary-700">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS (Lucide Wrapper) ---
        // Safely render icons avoiding React/DOM conflicts
        // --- ICONS (Lucide Wrapper) ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const ref = useRef(null);

            useEffect(() => {
                if (!ref.current || !window.lucide) return;

                // Helper to convert kebab-case to PascalCase
                const toPascal = (s) => s.split('-').map(p => p.charAt(0).toUpperCase() + p.slice(1)).join('');
                const pascalName = toPascal(name);
                const iconDef = window.lucide.icons ? (window.lucide.icons[pascalName] || window.lucide.icons[name]) : null;

                if (iconDef && window.lucide.createElement) {
                    try {
                        const svg = window.lucide.createElement(iconDef);
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        // Merge class names. Note: createElement might set class from attrs in iconDef if any?
                        // But usually we just setAttribute 'class'.
                        if (className) svg.setAttribute('class', className);

                        ref.current.innerHTML = '';
                        ref.current.appendChild(svg);
                    } catch (e) { console.error("Icon render error", e); }
                }
            }, [name, size, className]);

            return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{ width: size, height: size }}></span>;
        };

        // --- UTILS: SM2 ---
        const calculateSM2 = (question, isCorrect, currentReps) => {
            const now = Date.now();
            const prev = currentReps[question.id] || { ef: 2.5, rep: 0, interval: 0, next: 0 };
            let newRep = { ...prev, lastResult: isCorrect };

            if (isCorrect) {
                newRep.rep = prev.rep + 1;
                newRep.interval = newRep.rep === 1 ? 1 : newRep.rep === 2 ? 6 : Math.round(prev.interval * prev.ef);
                newRep.ef = Math.max(1.3, prev.ef + 0.1);
                newRep.next = now + newRep.interval * 24 * 60 * 60 * 1000;
            } else {
                newRep.rep = 0; newRep.interval = 0; newRep.next = now;
            }
            return newRep;
        };

        const generateUID = () => Math.random().toString(36).substr(2, 9);
        const INITIAL_QUESTIONS = [
            { id: 'init_1', epigrafe: 1, question: "Ejemplo: 쯇art칤cula con carga negativa?", options: ["Prot칩n", "Electr칩n", "Neutr칩n"], answer: 1, explanation: "El electr칩n tiene carga negativa." }
        ];
        const INITIAL_REPS = {};

        // --- HOOK: Question Bank ---
        const useQuestionBank = () => {
            const [questions, setQuestions] = useState([]);
            const [reps, setReps] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const q = localStorage.getItem('qBank_v2');
                const r = localStorage.getItem('reps_v2');
                if (q) setQuestions(JSON.parse(q));
                else setQuestions(INITIAL_QUESTIONS);
                if (r) setReps(JSON.parse(r));
                else setReps(INITIAL_REPS);
                setLoading(false);
            }, []);

            useEffect(() => {
                if (!loading) {
                    localStorage.setItem('qBank_v2', JSON.stringify(questions));
                    localStorage.setItem('reps_v2', JSON.stringify(reps));
                }
            }, [questions, reps, loading]);

            const importQuestions = async (filesList) => {
                let newQuestions = [];
                let errorCount = 0;

                for (let i = 0; i < filesList.length; i++) {
                    const file = filesList[i];
                    try {
                        const text = await file.text();
                        const json = JSON.parse(text);
                        if (Array.isArray(json)) {
                            // Validar y Sanitizar
                            const valid = json
                                .filter(q => q.question && Array.isArray(q.options)) // MUST BE ARRAY
                                .map(q => ({
                                    ...q,
                                    id: q.id || generateUID(),
                                    id: q.id || generateUID(),
                                    epigrafe: q.epigrafe || "General",
                                    // Ensure options is array just in case logic slips (redundant but safe)
                                    options: Array.isArray(q.options) ? q.options : []
                                }));
                            newQuestions = [...newQuestions, ...valid];
                        }
                    } catch (e) { console.error("Error leyendo archivo", file.name, e); errorCount++; }
                }

                if (newQuestions.length > 0) {
                    setQuestions(prev => {
                        return [...prev, ...newQuestions];
                    });
                    alert(`Importadas ${newQuestions.length} preguntas de ${filesList.length} archivos.` + (errorCount > 0 ? ` (${errorCount} errores)` : ''));
                } else {
                    alert("No se encontraron preguntas v치lidas (aseg칰rate de que tengan 'question' y 'options' como array).");
                }
            };

            const resetProgress = () => {
                if (window.confirm("쮼st치s SEGURO? Se borrar치 TODO el progreso (estad칤sticas), pero se mantendr치n las preguntas.")) {
                    setReps({});
                }
            };

            return { questions, reps, setQuestions, setReps, importQuestions, resetProgress, resetAll: resetProgress };
        };

        // --- COMPONENTS ---

        const Button = ({ children, onClick, variant = 'primary', className = "", ...props }) => {
            const base = "px-4 py-2 rounded-xl font-semibold transition-all duration-200 active:scale-95 flex items-center justify-center gap-2 shadow-sm";
            const variants = {
                primary: "bg-gradient-to-r from-primary-600 to-indigo-600 text-white hover:shadow-indigo-200 hover:shadow-lg",
                secondary: "bg-white text-slate-600 border border-slate-200 hover:bg-slate-50 hover:border-slate-300",
                danger: "bg-red-50 text-red-600 hover:bg-red-100 border border-red-100",
                ghost: "bg-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100/50"
            };
            return <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        };

        const Checkbox = ({ checked, onChange, label, className = "" }) => (
            <label onClick={onChange} className={`flex items-center gap-2 cursor-pointer select-none group ${className}`}>
                <div className={`w-5 h-5 rounded border flex items-center justify-center transition-all ${checked ? 'bg-primary-600 border-primary-600' : 'bg-white border-slate-300 group-hover:border-primary-400'}`}>
                    {checked && <Icon name="check" size={12} className="text-white" />}
                </div>
                <span className="text-sm text-slate-700 font-medium">{label}</span>
            </label>
        );

        // --- ADMIN PANEL ---
        const AdminPanel = ({ questions, reps, setQuestions, onImport, onBack }) => {
            const [searchTerm, setSearchTerm] = useState("");
            const [openEpigrafes, setOpenEpigrafes] = useState({});

            const groupedQuestions = useMemo(() => {
                const groups = {};
                questions.forEach(q => {
                    if (!groups[q.epigrafe]) groups[q.epigrafe] = [];
                    if (searchTerm === "" || q.question.toLowerCase().includes(searchTerm.toLowerCase())) {
                        groups[q.epigrafe].push(q);
                    }
                });
                return groups;
            }, [questions, searchTerm]);

            const epigrafes = Object.keys(groupedQuestions).sort((a, b) => a.toString().localeCompare(b.toString(), undefined, { numeric: true }));

            const toggleGroup = (epi) => setOpenEpigrafes(prev => ({ ...prev, [epi]: !prev[epi] }));

            const handleDeleteEpi = (epi) => {
                if (window.confirm(`쮹orrar TODAS las preguntas del Ep칤grafe ${epi}?`)) {
                    // Compare as strings to handle mixed types safely
                    setQuestions(prev => prev.filter(q => String(q.epigrafe) !== String(epi)));
                }
            };

            const handleDeleteQ = (id) => setQuestions(prev => prev.filter(q => q.id !== id));

            const handleBackup = () => {
                const dataStr = JSON.stringify(questions, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_pregunteitor_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
            };

            const handleFullHtmlBackup = () => {
                let html = document.documentElement.outerHTML;
                const questionsJson = JSON.stringify(questions);
                const repsJson = JSON.stringify(reps);

                // Regex to find INITIAL_QUESTIONS definition and replace it
                const qRegex = /const INITIAL_QUESTIONS = \[.*?\];/s;
                const rRegex = /const INITIAL_REPS = \{.*?\};/s;

                if (qRegex.test(html)) {
                    html = html.replace(qRegex, `const INITIAL_QUESTIONS = ${questionsJson};`);

                    if (rRegex.test(html)) {
                        html = html.replace(rRegex, `const INITIAL_REPS = ${repsJson};`);
                    } else {
                        // If didn't match (e.g. first time backup), try to insert after questions
                        html = html.replace(`const INITIAL_QUESTIONS = ${questionsJson};`, `const INITIAL_QUESTIONS = ${questionsJson};\n        const INITIAL_REPS = ${repsJson};`);
                    }

                    const blob = new Blob([html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `PregunteitorPlus_Full_${new Date().toISOString().slice(0, 10)}.html`;
                    a.click();
                } else {
                    alert("Error generando backup autom치tico. Intente guardar la p치gina (Ctrl+S).");
                }
            };

            return (
                <div className="max-w-4xl mx-auto glass-panel rounded-3xl p-6 md:p-10 animate-enter my-8">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Icon name="settings" /> Administraci칩n</h2>
                            <p className="text-slate-500 text-sm">Gestiona tu banco de preguntas</p>
                        </div>
                        <Button variant="secondary" onClick={onBack}>Volver</Button>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm">
                            <h3 className="font-semibold text-slate-700 mb-4 flex items-center gap-2"><Icon name="download" size={18} /> Importar</h3>
                            <div className="space-y-3">
                                <label className="block w-full cursor-pointer h-24 border-2 border-dashed border-slate-300 rounded-xl hover:bg-slate-50 hover:border-primary-400 transition-colors flex flex-col items-center justify-center text-slate-500">
                                    <Icon name="upload-cloud" size={24} className="mb-2 text-slate-400" />
                                    <span className="text-sm font-medium">Click para subir JSON(s)</span>
                                    <span className="text-xs text-slate-400">Soporta m칰ltiples archivos</span>
                                    <input type="file" multiple accept=".json" className="hidden" onChange={(e) => onImport(e.target.files)} />
                                </label>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex flex-col justify-center gap-3">
                            <h3 className="font-semibold text-slate-700 flex items-center gap-2"><Icon name="save" size={18} /> Acciones</h3>
                            <Button onClick={handleBackup} className="w-full justify-center"><Icon name="download" /> Descargar Backup (JSON)</Button>
                            <Button onClick={handleFullHtmlBackup} className="w-full justify-center bg-purple-600 hover:bg-purple-700 text-white"><Icon name="box" /> Backup App Completa (HTML)</Button>
                            <Button variant="danger" onClick={() => setQuestions([])} className="w-full justify-center"><Icon name="trash-2" /> Borrar Todo</Button>
                        </div>
                    </div>

                    <div className="space-y-4">
                        <div className="sticky top-0 bg-white/80 backdrop-blur z-10 p-2 -mx-2">
                            <input
                                type="text"
                                placeholder="游댌 Buscar pregunta..."
                                className="w-full p-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-primary-500 outline-none shadow-sm"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>

                        {epigrafes.length === 0 ? <p className="text-center text-slate-400 py-10">No hay preguntas.</p> : epigrafes.map(epi => (
                            <div key={epi} className="border border-slate-200 rounded-xl bg-white overflow-hidden shadow-sm">
                                <div
                                    className="p-4 bg-slate-50 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors"
                                    onClick={() => toggleGroup(epi)}
                                >
                                    <div className="flex items-center gap-3">
                                        <Icon name={openEpigrafes[epi] ? "chevron-down" : "chevron-right"} size={16} className="text-slate-400" />
                                        <span className="font-bold text-slate-700">Ep칤grafe {epi}</span>
                                        <span className="text-xs bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">{groupedQuestions[epi].length}</span>
                                    </div>
                                    <button onClick={(e) => { e.stopPropagation(); handleDeleteEpi(epi); }} className="text-xs text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash" size={14} /></button>
                                </div>

                                {openEpigrafes[epi] && (
                                    <div className="divide-y divide-slate-100">
                                        {groupedQuestions[epi].map(q => (
                                            <div key={q.id} className="p-4 hover:bg-slate-50 flex justify-between gap-4 group">
                                                <div className="text-sm text-slate-600">
                                                    <p className="font-medium text-slate-800 mb-1">{q.question}</p>
                                                    <div className="flex gap-2 text-xs opacity-70">
                                                        <span>Ans: {q.answer}</span>
                                                        <span>Opts: {q.options.length}</span>
                                                    </div>
                                                </div>
                                                <button onClick={() => handleDeleteQ(q.id)} className="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-600 transition-opacity"><Icon name="x-circle" size={18} /></button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- QUIZ PANEL ---
        const QuizPanel = ({ questions, mode, onComplete, onExit }) => {
            const [idx, setIdx] = useState(0);
            const [selected, setSelected] = useState(null);
            const [answers, setAnswers] = useState([]);
            const [showFeedback, setShowFeedback] = useState(false);
            const q = questions[idx];

            const handleSelect = (optIdx) => {
                if (showFeedback) return;
                setSelected(optIdx);
                if (mode === 'review') setShowFeedback(true);
            }

            const handleNext = () => {
                const isCorrect = selected === (q ? q.answer : -1);
                // If q is invalid, just move on without recording stats or record as skipped?
                // Better: if invalid, we likely didn't even render options.
                // But handleNext is called from button.

                const newAns = [...answers, { question: q || { id: 'err', question: 'Error' }, userAns: selected, correct: isCorrect }];

                if (idx < questions.length - 1) {
                    setAnswers(newAns);
                    setIdx(prev => prev + 1);
                    setSelected(null);
                    setShowFeedback(false);
                } else {
                    onComplete(newAns);
                }
            };

            // CRASH PREVENTION
            if (!q || !Array.isArray(q.options)) {
                return (
                    <div className="max-w-2xl mx-auto min-h-screen flex flex-col justify-center p-4 text-center">
                        <div className="p-6 bg-red-50 rounded-2xl border border-red-200">
                            <h3 className="text-red-700 font-bold mb-2">Error en los datos de la pregunta</h3>
                            <p className="text-red-500 mb-4">La pregunta 칤ndice {idx + 1} est치 da침ada o incompleta.</p>
                            <Button onClick={handleNext} variant="danger">Saltar Pregunta</Button>
                        </div>
                    </div>
                );
            }

            const searchGoogle = () => {
                const query = encodeURIComponent(q.question);
                window.open(`https://www.google.com/search?q=${query}`, '_blank');
            };

            // Keyboard Shortcuts
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (e.key === ' ' || e.code === 'Space') {
                        // Prevent scrolling
                        e.preventDefault();
                        if (selected !== null) handleNext();
                        return;
                    }

                    const key = parseInt(e.key);
                    if (!isNaN(key) && key >= 1 && key <= 4) {
                        const index = key - 1;
                        if (index < q.options.length) {
                            handleSelect(index);
                        }
                    }
                };

                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selected, q, idx]); // Deps needed for handleNext/Select closure

            const progress = ((idx + 1) / questions.length) * 100;

            return (
                <div className="max-w-5xl mx-auto min-h-screen flex flex-col justify-center p-4">
                    <div className="mb-6 flex justify-between items-center text-slate-500 text-sm font-mono">
                        <span>Pregunta {idx + 1} de {questions.length}</span>
                        <button onClick={onExit} className="hover:text-slate-800"><Icon name="x" /></button>
                    </div>

                    {/* Progress Bar */}
                    <div className="h-2 bg-slate-200 rounded-full mb-8 overflow-hidden">
                        <div className="h-full bg-primary-600 transition-all duration-300" style={{ width: `${progress}%` }}></div>
                    </div>

                    <div className="glass-panel p-6 md:p-10 rounded-3xl relative overflow-hidden mb-8 animate-enter">
                        <span className="bg-primary-50 text-primary-700 text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wider mb-4 inline-block">Ep칤grafe {q.epigrafe}</span>
                        <h2 className="text-xl md:text-2xl font-bold text-slate-800 mb-8 leading-snug">{q.question}</h2>

                        <div className="space-y-3">
                            {q.options.map((opt, i) => {
                                let stateClass = "border-slate-200 hover:border-primary-300 hover:bg-slate-50";
                                if (selected === i) stateClass = "border-primary-500 bg-primary-50 ring-1 ring-primary-500";
                                if (showFeedback) {
                                    if (i === q.answer) stateClass = "border-green-500 bg-green-50 text-green-700";
                                    else if (selected === i) stateClass = "border-red-500 bg-red-50 text-red-700";
                                    else stateClass = "opacity-50 border-slate-200";
                                }

                                return (
                                    <div
                                        key={i}
                                        onClick={() => handleSelect(i)}
                                        className={`p-4 border-2 rounded-xl cursor-pointer transition-all flex items-center gap-4 ${stateClass}`}
                                    >
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 ${selected === i || (showFeedback && i === q.answer) ? 'border-current' : 'border-slate-300 text-slate-400'}`}>
                                            {String.fromCharCode(65 + i)}
                                        </div>
                                        <span className="font-medium">{opt}</span>
                                        {showFeedback && i === q.answer && <Icon name="check-circle" className="ml-auto text-green-600" />}
                                    </div>
                                );
                            })}
                        </div>

                        {showFeedback && (
                            <div className="mt-6 animate-enter space-y-4">
                                <div className="p-4 bg-slate-50 rounded-xl border-l-4 border-slate-400 text-slate-600 text-sm">
                                    <p className="font-bold mb-1">Explicaci칩n:</p>
                                    {q.explanation || "Sin explicaci칩n disponible."}
                                </div>
                                <Button onClick={searchGoogle} variant="secondary" className="w-full text-sm">
                                    <Icon name="search" size={14} /> Buscar en Google
                                </Button>
                            </div>
                        )}
                    </div>

                    <div className="flex justify-end">
                        <Button
                            onClick={handleNext}
                            disabled={selected === null}
                            className={selected === null ? "opacity-50 cursor-not-allowed bg-slate-300" : "w-full md:w-auto text-lg py-3 px-8 shadow-xl shadow-primary-500/20"}
                        >
                            {idx === questions.length - 1 ? 'Finalizar Examen' : 'Siguiente Pregunta'} <Icon name="arrow-right" />
                        </Button>
                    </div>
                </div>
            );
        };

        // --- RESULTS PANEL ---
        const ResultsPanel = ({ results, onHome }) => {
            const score = Math.round((results.filter(r => r.correct).length / results.length) * 100);
            const [expanded, setExpanded] = useState({});

            const toggleExplain = (idx) => setExpanded(prev => ({ ...prev, [idx]: !prev[idx] }));

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center justify-center">
                    <div className="max-w-4xl w-full glass-panel p-8 rounded-[2.5rem] animate-enter shadow-2xl mb-8">
                        <header className="text-center mb-8">
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">춰Resumen del Examen!</h2>
                            <div className="text-6xl font-black text-primary-600 mb-4 font-mono tracking-tighter">
                                {score}%
                            </div>
                            <p className="text-slate-500">
                                Has acertado <strong className="text-slate-800">{results.filter(r => r.correct).length}</strong> de <strong className="text-slate-800">{results.length}</strong> preguntas.
                            </p>
                        </header>

                        <div className="space-y-6">
                            {results.map((r, idx) => {
                                const q = r.question;
                                const isCorrect = r.correct;
                                const userAns = r.userAns;

                                return (
                                    <div key={idx} className={`border-2 rounded-2xl p-6 ${isCorrect ? 'border-green-100 bg-green-50/50' : 'border-red-100 bg-red-50/50'}`}>
                                        <div className="flex gap-4">
                                            <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center font-bold ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                                                {isCorrect ? <Icon name="check" /> : <Icon name="x" />}
                                            </div>
                                            <div className="flex-grow">
                                                <h3 className="font-bold text-slate-800 text-lg mb-4">{q.question}</h3>

                                                <div className="space-y-2 mb-4">
                                                    {q.options.map((opt, optIdx) => {
                                                        let style = "border-slate-200 bg-white text-slate-500";
                                                        let icon = null;

                                                        if (optIdx === q.answer) {
                                                            style = "border-green-500 bg-green-100 text-green-700 font-bold ring-1 ring-green-500";
                                                            icon = <Icon name="check-circle" size={16} />;
                                                        } else if (optIdx === userAns) {
                                                            style = "border-red-500 bg-red-100 text-red-700 font-bold ring-1 ring-red-500";
                                                            icon = <Icon name="x-circle" size={16} />;
                                                        }

                                                        return (
                                                            <div key={optIdx} className={`p-3 rounded-xl border flex items-center justify-between text-sm ${style}`}>
                                                                <span className="flex gap-3">
                                                                    <span className="font-mono text-xs opacity-50 pt-0.5">{String.fromCharCode(65 + optIdx)}</span>
                                                                    {opt}
                                                                </span>
                                                                {icon}
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                <button
                                                    onClick={() => toggleExplain(idx)}
                                                    className="text-sm font-semibold text-primary-600 hover:text-primary-700 flex items-center gap-1"
                                                >
                                                    {expanded[idx] ? <Icon name="chevron-up" size={16} /> : <Icon name="chevron-down" size={16} />}
                                                    {expanded[idx] ? "Ocultar Explicaci칩n" : "Ver Explicaci칩n"}
                                                </button>

                                                {expanded[idx] && (
                                                    <div className="mt-3 p-4 bg-white/60 rounded-xl border border-slate-200 text-slate-600 text-sm animate-enter">
                                                        <strong className="text-slate-800">Explicaci칩n:</strong> {q.explanation || "No disponible."}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="max-w-4xl w-full mb-10">
                        <Button onClick={onHome} className="w-full py-4 text-lg justify-center shadow-xl">Volver al Inicio</Button>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const { questions, reps, importQuestions, setReps, setQuestions, resetAll } = useQuestionBank();
            const [view, setView] = useState('home'); // home, admin, quiz, results

            // Quiz Config State
            const [selectedEpis, setSelectedEpis] = useState([]); // Array of numbers
            const [questionCount, setQuestionCount] = useState(20);
            const [quizMode, setQuizMode] = useState('review');

            const [activeQuizQ, setActiveQuizQ] = useState([]);
            const [lastResults, setLastResults] = useState(null);

            // Derived data
            const availableEpis = useMemo(() => Array.from(new Set(questions.map(q => q.epigrafe))).sort((a, b) => String(a).localeCompare(String(b), undefined, { numeric: true })), [questions]);

            const stats = useMemo(() => {
                const total = questions.length;
                const studied = Object.keys(reps).length;
                const mastered = Object.values(reps).filter(r => r.ef > 2.5).length;
                return { total, studied, mastered };
            }, [questions, reps]);

            const toggleEpi = (e) => {
                setSelectedEpis(prev => prev.includes(e) ? prev.filter(x => x !== e) : [...prev, e]);
            };

            const selectAllEpis = () => setSelectedEpis(availableEpis);
            const deselectAllEpis = () => setSelectedEpis([]);

            const startQuiz = () => {
                const episToUse = selectedEpis.length > 0 ? selectedEpis : availableEpis;

                if (selectedEpis.length === 0) {
                    alert("Selecciona al menos un ep칤grafe.");
                    return;
                }

                let pool = questions.filter(q => episToUse.includes(q.epigrafe));

                // Filtrar dominadas (EF > 2.5)
                const notMastered = pool.filter(q => !reps[q.id] || reps[q.id].ef <= 2.5);

                if (notMastered.length === 0 && pool.length > 0) {
                    if (!window.confirm("춰Has dominado todas las preguntas de los temas seleccionados! 쯈uieres repasarlas de todos modos?")) {
                        return;
                    }
                    // Si confirma, usa el pool completo (aunque est칠n dominadas)
                } else {
                    pool = notMastered;
                }

                // Shuffle
                pool = pool.sort(() => Math.random() - 0.5).slice(0, questionCount);

                if (pool.length === 0) { alert("No hay preguntas disponibles con esos criterios."); return; }

                setActiveQuizQ(pool);
                setView('quiz');
            };

            const handleQuizComplete = (results) => {
                // Update SM2
                const newReps = { ...reps };
                results.forEach(r => {
                    newReps[r.question.id] = calculateSM2(r.question, r.correct, reps);
                });
                setReps(newReps);
                setLastResults(results);
                setView('results');
            };

            if (view === 'quiz') return <QuizPanel questions={activeQuizQ} mode={quizMode} onComplete={handleQuizComplete} onExit={() => setView('home')} />;

            if (view === 'admin') return <AdminPanel questions={questions} reps={reps} setQuestions={setQuestions} onImport={importQuestions} onBack={() => setView('home')} />;

            if (view === 'results') return <ResultsPanel results={lastResults} onHome={() => setView('home')} />;

            return (
                <div className="min-h-screen p-4 md:p-8 flex flex-col items-center justify-center">
                    <div className="max-w-4xl w-full glass-panel p-8 md:p-12 rounded-[2.5rem] relative overflow-hidden animate-enter shadow-2xl">
                        {/* Blob Backgrounds */}
                        <div className="absolute -top-20 -right-20 w-64 h-64 bg-primary-100 rounded-full blur-3xl opacity-50 pointer-events-none"></div>
                        <div className="absolute -bottom-20 -left-20 w-64 h-64 bg-secondary-500/20 rounded-full blur-3xl opacity-50 pointer-events-none"></div>

                        <header className="text-center mb-10 relative z-10">
                            <span className="text-primary-600 font-bold tracking-widest text-xs uppercase mb-2 block">Versi칩n Local Premium</span>
                            <h1 className="text-4xl md:text-5xl font-extrabold text-slate-800 mb-4 tracking-tight">
                                Pregunteitor<span className="text-primary-600">Plus</span>
                            </h1>
                            <p className="text-slate-500 max-w-md mx-auto">Tu plataforma definitiva para repasar y dominar el temario. Selecciona tus temas y comienza.</p>
                        </header>

                        {/* Stats Counters */}
                        <div className="grid grid-cols-3 gap-4 mb-8 relative z-10 animate-fade-in">
                            <div className="bg-white/80 p-4 rounded-2xl text-center border border-white shadow-sm backdrop-blur-sm">
                                <span className="block text-2xl md:text-3xl font-black text-slate-700">{stats.total}</span>
                                <span className="text-[10px] md:text-xs text-slate-400 uppercase font-bold tracking-wider">Preguntas</span>
                            </div>
                            <div className="bg-blue-50/80 p-4 rounded-2xl text-center border border-blue-100 shadow-sm backdrop-blur-sm">
                                <span className="block text-2xl md:text-3xl font-black text-blue-600">{stats.studied}</span>
                                <span className="text-[10px] md:text-xs text-blue-400 uppercase font-bold tracking-wider">Estudiadas</span>
                            </div>
                            <div className="bg-green-50/80 p-4 rounded-2xl text-center border border-green-100 shadow-sm backdrop-blur-sm">
                                <span className="block text-2xl md:text-3xl font-black text-green-600">{stats.mastered}</span>
                                <span className="text-[10px] md:text-xs text-green-400 uppercase font-bold tracking-wider">Dominadas</span>
                            </div>
                        </div>

                        <div className="grid md:grid-cols-2 gap-8 relative z-10">
                            <div className="space-y-6">
                                <div className="bg-white/60 p-6 rounded-2xl border border-white shadow-inner">
                                    <h3 className="font-bold text-slate-700 mb-4 flex justify-between items-center">
                                        Selecci칩n de Temas
                                        <div className="flex gap-2">
                                            <button onClick={selectAllEpis} className="text-xs text-primary-600 hover:underline">Todos</button>
                                            <button onClick={deselectAllEpis} className="text-xs text-slate-400 hover:underline">Ninguno</button>
                                        </div>
                                    </h3>
                                    <div className="max-h-60 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                                        {availableEpis.map(epi => (
                                            <Checkbox
                                                key={epi}
                                                label={`Ep칤grafe ${epi}`}
                                                checked={selectedEpis.includes(epi)}
                                                onChange={() => toggleEpi(epi)}
                                                className="p-2 hover:bg-white/80 rounded-lg transition-colors"
                                            />
                                        ))}
                                        {availableEpis.length === 0 && <p className="text-sm text-slate-400 italic">No hay preguntas cargadas.</p>}
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-6 flex flex-col justify-center">
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-bold text-slate-700 mb-1 block">Modo</label>
                                        <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1.5 rounded-xl">
                                            <button onClick={() => setQuizMode('review')} className={`py-2 px-4 rounded-lg text-sm font-bold transition-all ${quizMode === 'review' ? 'bg-white shadow text-primary-600' : 'text-slate-400'}`}>Repaso</button>
                                            <button onClick={() => setQuizMode('exam')} className={`py-2 px-4 rounded-lg text-sm font-bold transition-all ${quizMode === 'exam' ? 'bg-white shadow text-primary-600' : 'text-slate-400'}`}>Examen</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-sm font-bold text-slate-700 mb-1 block">Preguntas</label>
                                        <input type="number" value={questionCount} onChange={e => setQuestionCount(Number(e.target.value))} className="w-full p-3 bg-white border border-slate-200 rounded-xl font-bold text-slate-700 focus:outline-none focus:ring-2 focus:ring-primary-500" />
                                    </div>
                                </div>

                                <Button onClick={startQuiz} className="w-full py-4 text-lg justify-center shadow-primary-500/25 shadow-xl">
                                    Comenzar <Icon name="play" fill="currentColor" />
                                </Button>

                                <div className="flex gap-3 pt-4 border-t border-slate-200/50">
                                    <Button variant="ghost" onClick={() => setView('admin')} className="flex-1 text-sm"><Icon name="settings" size={16} /> Admin</Button>
                                    <Button variant="ghost" onClick={resetAll} className="flex-1 text-sm hover:text-red-500"><Icon name="refresh-cw" size={16} /> Reset</Button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <footer className="mt-8 text-slate-400 text-sm font-medium">
                        PregunteitorPlus Local 춸 2025
                    </footer>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>